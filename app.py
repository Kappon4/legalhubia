import streamlit as st
import google.generativeai as genai
from pypdf import PdfReader
from docx import Document
from io import BytesIO
from duckduckgo_search import DDGS
from datetime import datetime, timedelta, date
import time
import pandas as pd
import base64
import sys
import socket
from urllib.parse import urlparse

# ==========================================================
# 1. SETUP INICIAL
# ==========================================================
try:
    import psycopg2
    LIB_OK = True
except ImportError:
    LIB_OK = False
    psycopg2 = None

st.set_page_config(
    page_title="LegalHub Elite v8.9", 
    page_icon="‚öñÔ∏è", 
    layout="wide",
    initial_sidebar_state="expanded"
)

# Verifica Secrets
try:
    DB_URI = st.secrets["DB_URI"]
    API_KEY_FIXA = st.secrets["GOOGLE_API_KEY"]
    SECRETS_OK = True
except:
    DB_URI = ""
    API_KEY_FIXA = ""
    SECRETS_OK = False

CONEXAO_NUVEM = (LIB_OK and SECRETS_OK)

# ==========================================================
# 2. CONEX√ÉO COM BANCO (COM "HACK" DE IPv4)
# ==========================================================
def get_ipv4_connection_string(uri):
    """
    Fun√ß√£o Hacker: For√ßa a resolu√ß√£o DNS para IPv4
    para evitar o erro 'Cannot assign requested address' no Streamlit Cloud.
    """
    try:
        parsed = urlparse(uri)
        hostname = parsed.hostname
        # Resolve o nome para um IP num√©rico (IPv4)
        ipv4 = socket.gethostbyname(hostname)
        # Substitui o nome pelo IP na string de conex√£o
        new_uri = uri.replace(hostname, ipv4)
        return new_uri
    except Exception as e:
        # Se falhar, retorna o original e torce para funcionar
        return uri

def get_db_connection():
    if CONEXAO_NUVEM:
        try:
            # Tenta conex√£o normal
            return psycopg2.connect(DB_URI, sslmode='require')
        except Exception as e_ipv6:
            try:
                # Se falhar, tenta o Hack IPv4
                uri_ipv4 = get_ipv4_connection_string(DB_URI)
                return psycopg2.connect(uri_ipv4, sslmode='require')
            except Exception as e_final:
                st.toast(f"Erro Fatal Conex√£o: {e_final}", icon="‚ùå")
                return None
    else:
        import sqlite3
        return sqlite3.connect(':memory:', check_same_thread=False)

def run_query(query, params=(), return_data=False):
    conn = get_db_connection()
    if conn is None: return None
    try:
        c = conn.cursor()
        if not CONEXAO_NUVEM: query = query.replace('%s', '?')
        
        c.execute(query, params)
        
        if return_data:
            data = c.fetchall()
            if c.description:
                col_names = [desc[0] for desc in c.description]
                conn.close()
                return pd.DataFrame(data, columns=col_names)
            else:
                conn.close()
                return None
        else:
            conn.commit()
            conn.close()
            return True
    except Exception as e:
        if conn: conn.close()
        st.error(f"ERRO SQL: {e}")
        return None

# --- CRIA√á√ÉO AUTOM√ÅTICA (TENTATIVA SILENCIOSA) ---
if CONEXAO_NUVEM:
    try:
        run_query("CREATE TABLE IF NOT EXISTS usuarios (username TEXT PRIMARY KEY, senha TEXT, escritorio TEXT, email_oab TEXT, creditos INTEGER DEFAULT 10, plano TEXT DEFAULT 'starter')")
        run_query("CREATE TABLE IF NOT EXISTS documentos (id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, escritorio TEXT, data_criacao TEXT, cliente TEXT, area TEXT, tipo TEXT, conteudo TEXT)")
    except: pass

# ==========================================================
# 3. FUN√á√ïES GERAIS (MANTENDO TUDO)
# ==========================================================
def get_base64_of_bin_file(bin_file):
    try:
        with open(bin_file, 'rb') as f: data = f.read()
        return base64.b64encode(data).decode()
    except: return None

def gerar_word(texto):
    doc = Document(); 
    for p in texto.split('\n'): 
        if p.strip(): doc.add_paragraph(p)
    buf = BytesIO(); doc.save(buf); buf.seek(0)
    return buf

def extrair_texto_pdf(arquivo):
    try: return "".join([p.extract_text() for p in PdfReader(arquivo).pages])
    except: return ""

def buscar_contexto_juridico(tema, area):
    fontes = {"Criminal": "site:stj.jus.br", "Trabalhista": "site:tst.jus.br", "C√≠vel": "site:stj.jus.br"}
    query = f"{tema} jurisprud√™ncia {fontes.get(area, 'site:jusbrasil.com.br')}"
    try:
        with DDGS() as ddgs:
            res = list(ddgs.text(query, region="br-pt", max_results=3))
            if res: return "\n\n[JURISPRUD√äNCIA]:\n" + "\n".join([f"- {r['body']}" for r in res])
    except: pass
    return ""

def tentar_gerar_conteudo(prompt, api_key_val):
    chave = api_key_val if api_key_val else API_KEY_FIXA
    if not chave: return "‚ö†Ô∏è Configure a API Key."
    genai.configure(api_key=chave)
    try:
        return genai.GenerativeModel("gemini-1.5-flash").generate_content(prompt).text
    except Exception as e: return f"‚ùå Erro IA: {e}"

def calcular_rescisao_completa(admissao, demissao, salario, motivo, saldo_fgts, ferias_venc, aviso, insal, peric):
    verbas = {}
    base = salario
    if peric: base += salario * 0.3
    if insal == "M√≠nimo": base += 1412 * 0.1
    elif insal == "M√©dio": base += 1412 * 0.2
    elif insal == "M√°ximo": base += 1412 * 0.4
    
    d1 = datetime.strptime(str(admissao), "%Y-%m-%d")
    d2 = datetime.strptime(str(demissao), "%Y-%m-%d")
    
    verbas["Saldo Sal√°rio"] = (base/30) * d2.day
    meses = (d2.year - d1.year) * 12 + d2.month - d1.month
    
    if motivo == "Demiss√£o sem Justa Causa":
        verbas["Multa 40% FGTS"] = saldo_fgts * 0.4
        aviso_dias = min(90, 30 + (3 * (meses//12)))
        if aviso == "Indenizado": verbas[f"Aviso ({aviso_dias}d)"] = (base/30)*aviso_dias
    return verbas

# --- CSS ---
def local_css():
    st.markdown("""<style>
        .stApp { background-color: #0e1117; color: white; }
        .stButton>button { border: 1px solid #00F3FF; color: #00F3FF; background: transparent; width: 100%; }
        h1, h2 { color: #00F3FF !important; }
    </style>""", unsafe_allow_html=True)
local_css()

# ==========================================================
# 4. LOGIN (COM REPARO E CORRE√á√ÉO DE REDE)
# ==========================================================
if "logado" not in st.session_state: st.session_state.logado = False
if "usuario_atual" not in st.session_state: st.session_state.usuario_atual = ""

if not st.session_state.logado:
    col1, col2, col3 = st.columns([1, 1.2, 1])
    with col2:
        st.markdown("<br><h1 style='text-align: center;'>üõ°Ô∏è LEGALHUB</h1>", unsafe_allow_html=True)
        
        if CONEXAO_NUVEM:
             st.success("‚òÅÔ∏è CONEX√ÉO SEGURA (IPv4 Patch Ativo)")
        else:
             st.warning("‚ö†Ô∏è MODO OFFLINE")

        with st.container(border=True):
            tab1, tab2, tab3 = st.tabs(["ENTRAR", "CADASTRAR", "üîß SUPORTE"])
            
            with tab1:
                u = st.text_input("Usu√°rio", key="u").strip().lower()
                p = st.text_input("Senha", type="password", key="p").strip()
                if st.button("LOGIN", use_container_width=True):
                    res = run_query("SELECT * FROM usuarios WHERE username = %s AND senha = %s", (u, p), return_data=True)
                    if res is not None and not res.empty:
                        st.session_state.logado = True
                        st.session_state.usuario_atual = u
                        st.session_state.escritorio_atual = res.iloc[0]['escritorio']
                        st.session_state.plano_atual = res.iloc[0]['plano']
                        st.rerun()
                    else: st.error("Dados inv√°lidos ou usu√°rio inexistente.")
                
                if st.button("üÜò Resetar Admin"):
                    if run_query("INSERT INTO usuarios (username, senha, escritorio, email_oab, creditos, plano) VALUES ('admin', 'admin', 'Master Office', 'adm@lh.com', 9999, 'full') ON CONFLICT (username) DO UPDATE SET senha='admin'"):
                        st.success("Admin resetado! Use: admin / admin")
                    else:
                        st.error("Falha ao resetar. Tente a aba SUPORTE.")
            
            with tab2:
                nu = st.text_input("Novo Usu√°rio").strip().lower()
                np = st.text_input("Nova Senha").strip()
                ne = st.text_input("Escrit√≥rio")
                if st.button("CADASTRAR", use_container_width=True):
                    if run_query("INSERT INTO usuarios (username, senha, escritorio, creditos, plano) VALUES (%s, %s, %s, 10, 'starter')", (nu, np, ne)):
                        st.success("Sucesso! Fa√ßa login.")
                    else: st.error("Erro ao salvar. Verifique se usu√°rio j√° existe.")

            with tab3:
                st.warning("Se estiver vendo erros de conex√£o, clique abaixo.")
                if st.button("üõ†Ô∏è REPARAR BANCO DE DADOS (RESET TOTAL)", use_container_width=True):
                    with st.spinner("Aplicando corre√ß√£o de rede e limpando tabelas..."):
                        run_query("DROP TABLE IF EXISTS usuarios")
                        run_query("DROP TABLE IF EXISTS documentos")
                        run_query("CREATE TABLE usuarios (username TEXT PRIMARY KEY, senha TEXT, escritorio TEXT, email_oab TEXT, creditos INTEGER DEFAULT 10, plano TEXT DEFAULT 'starter')")
                        run_query("CREATE TABLE documentos (id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, escritorio TEXT, data_criacao TEXT, cliente TEXT, area TEXT, tipo TEXT, conteudo TEXT)")
                        run_query("INSERT INTO usuarios (username, senha, escritorio, creditos, plano) VALUES ('admin', 'admin', 'Master Office', 9999, 'full')")
                        st.success("Banco reparado! Tente logar com admin/admin.")
    st.stop()

# ==========================================================
# 5. SISTEMA PRINCIPAL
# ==========================================================
df_user = run_query("SELECT creditos, plano FROM usuarios WHERE username = %s", (st.session_state.usuario_atual,), return_data=True)
creditos = df_user.iloc[0]['creditos'] if df_user is not None else 0
plano = st.session_state.plano_atual = df_user.iloc[0]['plano'] if df_user is not None else "starter"

with st.sidebar:
    st.title("MENU")
    st.caption(f"User: {st.session_state.usuario_atual}")
    
    if "navegacao_override" not in st.session_state: st.session_state.navegacao_override = None
    mapa = {"Dashboard": "üìä Dashboard", "Redator": "‚úçÔ∏è Redator Jur√≠dico", "Calculos": "üßÆ C√°lculos", "Contratos": "üìú Contratos", "Cofre": "üìÇ Cofre"}
    
    idx = 0
    if st.session_state.navegacao_override:
        try: idx = list(mapa.values()).index(st.session_state.navegacao_override)
        except: pass
        st.session_state.navegacao_override = None
        
    escolha = st.radio("Navegar", list(mapa.keys()), index=idx)
    menu = mapa[escolha]
    
    st.divider()
    if st.session_state.usuario_atual == 'admin':
        with st.expander("‚öôÔ∏è ADMIN"):
            all_users = run_query("SELECT username, plano FROM usuarios", return_data=True)
            if all_users is not None: st.dataframe(all_users)
            
            user_to_edit = st.selectbox("Usu√°rio", all_users['username'].unique() if all_users is not None else [])
            new_plan = st.selectbox("Novo Plano", ["starter", "full"])
            if st.button("Salvar Plano"):
                run_query("UPDATE usuarios SET plano = %s WHERE username = %s", (new_plan, user_to_edit))
                st.success("Atualizado!")
                time.sleep(1); st.rerun()

    if st.button("SAIR"): st.session_state.logado = False; st.rerun()

# --- TELAS ---
if menu == "üìä Dashboard":
    st.header("üìä Vis√£o Geral")
    docs = run_query("SELECT count(*) FROM documentos WHERE escritorio = %s", (st.session_state.escritorio_atual,), return_data=True)
    c1, c2 = st.columns(2)
    c1.metric("Documentos", docs.iloc[0][0] if docs is not None else 0)
    c2.metric("Plano", plano.upper())
    
    st.markdown("### Acesso R√°pido")
    c1, c2 = st.columns(2)
    if c1.button("Nova Pe√ßa"): st.session_state.navegacao_override = "‚úçÔ∏è Redator Jur√≠dico"; st.rerun()
    if c2.button("Novo C√°lculo"): st.session_state.navegacao_override = "üßÆ C√°lculos"; st.rerun()

elif menu == "‚úçÔ∏è Redator Jur√≠dico":
    st.header("‚úçÔ∏è Redator IA (Anti-Alucina√ß√£o)")
    area = st.selectbox("√Årea", ["C√≠vel", "Trabalhista", "Criminal", "Tribut√°rio", "Previdenci√°rio"])
    pecas = ["Peti√ß√£o Inicial", "Contesta√ß√£o", "R√©plica", "Recurso", "Habeas Corpus", "Mandado de Seguran√ßa", "Reclama√ß√£o Trabalhista"]
    tipo = st.selectbox("Pe√ßa", pecas)
    c1, c2 = st.columns(2)
    cli = c1.text_input("Cliente")
    fatos = st.text_area("Fatos")
    if st.button("GERAR"):
        with st.spinner("Redigindo..."):
            ctx = buscar_contexto_juridico(f"{tipo} {fatos}", area)
            res = tentar_gerar_conteudo(f"Advogado {area}. Redija {tipo}. Cliente: {cli}. Fatos: {fatos}. {ctx}", api_key)
            st.markdown(res)
            if "‚ùå" not in res:
                run_query("INSERT INTO documentos (escritorio, data_criacao, cliente, area, tipo, conteudo) VALUES (%s, %s, %s, %s, %s, %s)", 
                         (st.session_state.escritorio_atual, str(date.today()), cli, area, tipo, res))
                st.download_button("Baixar", gerar_word(res), "Peca.docx")

elif menu == "üßÆ C√°lculos":
    st.header("üßÆ Central de C√°lculos")
    mod = st.selectbox("M√≥dulo", ["Trabalhista", "C√≠vel (Liquida√ß√£o)", "Fam√≠lia", "Tribut√°ria"])
    
    if mod == "Trabalhista":
        st.info("Rescis√£o CLT")
        c1, c2 = st.columns(2)
        adm = c1.date_input("Admiss√£o", date(2022,1,1))
        dem = c2.date_input("Demiss√£o")
        sal = st.number_input("Sal√°rio")
        motivo = st.selectbox("Motivo", ["Demiss√£o sem Justa Causa", "Pedido Demiss√£o"])
        if st.button("Calcular"):
            v = calcular_rescisao_completa(adm, dem, sal, motivo, 0, False, "Indenizado", "N√£o", False)
            st.dataframe(pd.DataFrame(list(v.items()), columns=["Verba", "Valor"]))
            
    elif mod == "C√≠vel (Liquida√ß√£o)":
        st.info("Liquida√ß√£o de Senten√ßa + Art 523")
        val = st.number_input("Valor Condena√ß√£o")
        idx = st.number_input("√çndice Corre√ß√£o", 1.0)
        multa = st.checkbox("Multa 10%")
        hon = st.checkbox("Honor√°rios 10%")
        if st.button("Liquidar"):
            total = val * idx
            if multa: total += total * 0.1
            if hon: total += total * 0.1
            st.success(f"Total: R$ {total:,.2f}")

    elif mod == "Fam√≠lia":
        st.info("Pens√£o Aliment√≠cia")
        r = st.number_input("Renda")
        f = st.slider("Filhos", 1, 5)
        if st.button("Calcular"): st.success(f"Sugerido: R$ {r * (0.3 + (f-1)*0.05):,.2f}")

elif menu == "üìú Contratos":
    st.header("Gerador de Contratos")
    cli = st.text_input("Cliente")
    if st.button("Gerar"):
        res = tentar_gerar_conteudo(f"Contrato honor√°rios para {cli}", api_key)
        st.markdown(res)

elif menu == "üìÇ Cofre":
    st.header("Cofre Digital")
    df = run_query("SELECT * FROM documentos WHERE escritorio = %s ORDER BY id DESC", (st.session_state.escritorio_atual,), return_data=True)
    if df is not None:
        for i, row in df.iterrows():
            with st.expander(f"{row['tipo']} - {row['cliente']}"):
                st.write(row['conteudo'][:200])
                st.download_button("Baixar", gerar_word(row['conteudo']), "Doc.docx", key=f"d{i}")
