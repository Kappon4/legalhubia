import streamlit as st
import google.generativeai as genai
from pypdf import PdfReader
from docx import Document
from io import BytesIO
from duckduckgo_search import DDGS
from datetime import datetime, date
import time
import pandas as pd
import requests
import psycopg2 # Agora importamos direto, pois o requirements.txt vai instalar

# ==========================================================
# 1. CONFIGURA√á√ÉO VISUAL
# ==========================================================
st.set_page_config(
    page_title="LegalHub Elite v7", 
    page_icon="‚öñÔ∏è", 
    layout="wide",
    initial_sidebar_state="expanded"
)

# ==========================================================
# 2. CONEX√ÉO COM BANCO DE DADOS (VIA SECRETS)
# ==========================================================
try:
    # Tenta pegar as senhas configuradas no site do Streamlit
    DB_URI = st.secrets["DB_URI"]
    API_KEY_FIXA = st.secrets["GOOGLE_API_KEY"]
    USAR_SQLITE_BACKUP = False
except:
    # Fallback local (caso rode sem secrets configurados)
    USAR_SQLITE_BACKUP = True
    API_KEY_FIXA = "" 
    # Se quiser testar local, descomente e coloque sua senha abaixo:
    # DB_URI = "postgresql://postgres:SUA_SENHA@db...supabase.co:5432/postgres"

def get_db_connection():
    if USAR_SQLITE_BACKUP:
        import sqlite3
        return sqlite3.connect('legalhub.db')
    else:
        return psycopg2.connect(DB_URI)

def run_query(query, params=(), return_data=False):
    conn = None
    try:
        conn = get_db_connection()
        c = conn.cursor()
        
        # Adapta√ß√£o de sintaxe (SQLite = ? / Postgres = %s)
        if USAR_SQLITE_BACKUP:
            query = query.replace('%s', '?')
            
        c.execute(query, params)
        
        if return_data:
            data = c.fetchall()
            col_names = [desc[0] for desc in c.description] if c.description else []
            conn.close()
            return pd.DataFrame(data, columns=col_names)
        else:
            conn.commit()
            conn.close()
            return True
    except Exception as e:
        if conn: conn.close()
        return None

# ==========================================================
# 3. FUN√á√ïES DE IA E UTILIT√ÅRIOS
# ==========================================================
def gerar_word(texto):
    doc = Document()
    for p in texto.split('\n'):
        if p.strip(): doc.add_paragraph(p)
    buf = BytesIO()
    doc.save(buf)
    buf.seek(0)
    return buf

def extrair_texto_pdf(arquivo):
    try: return "".join([p.extract_text() for p in PdfReader(arquivo).pages])
    except: return ""

def tentar_gerar_conteudo(prompt, api_key_val):
    chave = api_key_val if api_key_val else API_KEY_FIXA
    if not chave: return "‚ö†Ô∏è Erro: API Key n√£o configurada nos Secrets."
    
    genai.configure(api_key=chave)
    modelos = ["gemini-2.5-flash", "gemini-1.5-pro", "gemini-1.5-flash"]
    
    for modelo in modelos:
        try:
            m = genai.GenerativeModel(modelo)
            return m.generate_content(prompt).text
        except: continue
            
    return "‚ùå Erro na IA: Verifique sua Chave API ou conex√£o."

# ==========================================================
# 4. INICIALIZA√á√ÉO
# ==========================================================
# Garante tabelas
try:
    if USAR_SQLITE_BACKUP:
        run_query("CREATE TABLE IF NOT EXISTS usuarios (username TEXT PRIMARY KEY, senha TEXT, escritorio TEXT, email_oab TEXT, creditos INTEGER DEFAULT 10, plano TEXT DEFAULT 'starter')")
        run_query("CREATE TABLE IF NOT EXISTS documentos (id INTEGER PRIMARY KEY AUTOINCREMENT, escritorio TEXT, data_criacao TEXT, cliente TEXT, area TEXT, tipo TEXT, conteudo TEXT)")
    else:
        run_query("CREATE TABLE IF NOT EXISTS usuarios (username TEXT PRIMARY KEY, senha TEXT, escritorio TEXT, email_oab TEXT, creditos INTEGER DEFAULT 10, plano TEXT DEFAULT 'starter')")
        run_query("CREATE TABLE IF NOT EXISTS documentos (id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, escritorio TEXT, data_criacao TEXT, cliente TEXT, area TEXT, tipo TEXT, conteudo TEXT)")
    
    # Cria admin padr√£o
    run_query("INSERT INTO usuarios (username, senha, escritorio, email_oab, creditos, plano) VALUES (%s, %s, %s, %s, %s, %s) ON CONFLICT DO NOTHING", ('admin', 'admin', 'Master Office', 'adm@lh.com', 9999, 'full'))
except: pass

if "logado" not in st.session_state: st.session_state.logado = False
if "usuario_atual" not in st.session_state: st.session_state.usuario_atual = ""

# --- TELA DE LOGIN ---
if not st.session_state.logado:
    st.markdown("<br><h1 style='text-align:center'>üõ°Ô∏è LEGALHUB ELITE</h1>", unsafe_allow_html=True)
    
    if not USAR_SQLITE_BACKUP: 
        st.success("‚òÅÔ∏è CONECTADO AO BANCO DE DADOS (SUPABASE)")
    else:
        st.warning("‚ö†Ô∏è MODO OFFLINE (SECRETS N√ÉO ENCONTRADOS)")
    
    c1, c2, c3 = st.columns([1, 1, 1])
    with c2:
        with st.container(border=True):
            user = st.text_input("Usu√°rio")
            pwd = st.text_input("Senha", type="password")
            if st.button("ENTRAR", use_container_width=True):
                res = run_query("SELECT * FROM usuarios WHERE username = %s AND senha = %s", (user, pwd), return_data=True)
                if res is not None and not res.empty:
                    st.session_state.logado = True
                    st.session_state.usuario_atual = user
                    st.session_state.escritorio_atual = res.iloc[0]['escritorio']
                    st.session_state.plano_atual = res.iloc[0]['plano']
                    st.rerun()
                else: st.error("Dados inv√°lidos.")
    st.stop()

# ==========================================================
# 5. APP PRINCIPAL
# ==========================================================
st.markdown("""<style>
    .stApp { background-color: #0e1117; color: white; }
    h1, h2, h3 { color: #00F3FF !important; }
    .stButton>button { border: 1px solid #00F3FF; color: #00F3FF; background: transparent; width: 100%; }
    .stButton>button:hover { background: #00F3FF; color: black; }
</style>""", unsafe_allow_html=True)

with st.sidebar:
    st.title("üõ°Ô∏è MENU")
    st.caption(f"Logado: {st.session_state.usuario_atual}")
    
    # MENU COMPLETO COM CONTRATOS
    menu = st.radio("Navega√ß√£o", ["Dashboard", "Redator IA", "üìú Contratos", "Calculadoras", "Cofre Digital"])
    
    st.divider()
    if st.button("Sair"): st.session_state.logado = False; st.rerun()

# --- TELAS ---

if menu == "Dashboard":
    st.header("üìä Vis√£o Geral")
    docs = run_query("SELECT count(*) FROM documentos WHERE escritorio = %s", (st.session_state.escritorio_atual,), return_data=True)
    qtd = docs.iloc[0][0] if docs is not None else 0
    
    c1, c2 = st.columns(2)
    c1.metric("Documentos", qtd)
    c2.metric("Banco de Dados", "Supabase (Nuvem)" if not USAR_SQLITE_BACKUP else "Local (Risco)")

elif menu == "Redator IA":
    st.header("‚úçÔ∏è Redator Jur√≠dico")
    c1, c2 = st.columns([1, 2])
    with c1:
        tipo = st.selectbox("Pe√ßa", ["Peti√ß√£o Inicial", "Contesta√ß√£o", "Habeas Corpus", "Recurso", "Notifica√ß√£o"])
        cli = st.text_input("Cliente")
    with c2:
        fatos = st.text_area("Fatos", height=150)
        
    if st.button("Gerar Pe√ßa"):
        if fatos and cli:
            with st.spinner("IA Trabalhando..."):
                prompt = f"Advogado. Redija {tipo}. Cliente: {cli}. Fatos: {fatos}."
                res = tentar_gerar_conteudo(prompt, None)
                st.markdown(res)
                if "‚ùå" not in res:
                    run_query("INSERT INTO documentos (escritorio, data_criacao, cliente, area, tipo, conteudo) VALUES (%s, %s, %s, %s, %s, %s)", 
                             (st.session_state.escritorio_atual, str(date.today()), cli, "Geral", tipo, res))
                    st.download_button("Baixar", gerar_word(res), f"{tipo}.docx")

elif menu == "üìú Contratos":
    st.header("üìú Gerador de Contratos")
    tab1, tab2 = st.tabs(["Contrato", "Procura√ß√£o"])
    
    with tab1:
        c1, c2 = st.columns(2)
        cliente = c1.text_input("Nome Cliente")
        cpf = c2.text_input("CPF/CNPJ")
        valor = c1.number_input("Valor (R$)", step=100.0)
        forma = c2.selectbox("Pagamento", ["√Ä Vista", "Parcelado", "No √äxito"])
        objeto = st.text_area("Objeto do Servi√ßo")
        
        if st.button("Criar Contrato"):
            with st.spinner("Redigindo contrato..."):
                prompt = f"Redija contrato de honor√°rios. Cliente: {cliente}, CPF {cpf}. Valor: R$ {valor}. Forma: {forma}. Objeto: {objeto}. Contratado: {st.session_state.escritorio_atual}. Incluir cl√°usulas de foro e multa."
                res = tentar_gerar_conteudo(prompt, None)
                st.markdown(res)
                if "‚ùå" not in res:
                    st.download_button("Baixar DOCX", gerar_word(res), "Contrato.docx")
                    run_query("INSERT INTO documentos (escritorio, data_criacao, cliente, area, tipo, conteudo) VALUES (%s, %s, %s, %s, %s, %s)", 
                             (st.session_state.escritorio_atual, str(date.today()), cliente, "Contratos", "Contrato Honor√°rios", res))

    with tab2:
        out = st.text_input("Outorgante (Cliente)")
        dados = st.text_input("Dados Completos (Nac, Est. Civil, Prof, RG, CPF, Endere√ßo)")
        if st.button("Criar Procura√ß√£o"):
            prompt = f"Redija Procura√ß√£o Ad Judicia. Outorgante: {out}, {dados}. Outorgado: {st.session_state.escritorio_atual}."
            res = tentar_gerar_conteudo(prompt, None)
            st.markdown(res)
            st.download_button("Baixar DOCX", gerar_word(res), "Procuracao.docx")

elif menu == "Calculadoras":
    st.header("üßÆ Calculadoras")
    val = st.number_input("Valor da Causa")
    if st.button("Calcular"): st.success(f"Atualizado: R$ {val * 1.05:.2f}")

elif menu == "Cofre Digital":
    st.header("üìÇ Documentos Salvos")
    df = run_query("SELECT * FROM documentos WHERE escritorio = %s ORDER BY id DESC", (st.session_state.escritorio_atual,), return_data=True)
    if df is not None and not df.empty:
        for i, row in df.iterrows():
            with st.expander(f"{row['data_criacao']} - {row['tipo']} ({row['cliente']})"):
                st.write(row['conteudo'][:300] + "...")
                c1, c2 = st.columns([1, 5])
                with c1: st.download_button("Baixar", gerar_word(row['conteudo']), "Doc.docx", key=f"d{i}")
                with c2: 
                    if st.button("Excluir", key=f"x{i}"):
                        run_query("DELETE FROM documentos WHERE id = %s", (row['id'],))
                        st.rerun()
    else: st.info("Cofre vazio.")
